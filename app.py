# -*- coding: utf-8 -*-

import streamlit as st
from google.cloud import translate_v2 as translate
from google.oauth2 import service_account
import time
import re
import random

# ==========================================================
# ‡∂∏‡∑ú‡∑Ö‡∂∫ 1: ‡∂¥‡∑î‡∑É‡∑ä‡∂≠‡∂ö‡∑è‡∂Ω‡∂∫ (‡∂±‡∑í‡∂∫‡∂≠ ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫)
# ==========================================================
correction_rules = {
    # ‡∂±‡∑í‡∂∫‡∂≠, ‡∂ë‡∂ö‡∂∏ ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∂ö‡∑ä ‡∂á‡∂≠‡∑í ‡∂ª‡∑ì‡∂≠‡∑í
    "‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∂ö‡∑ä ‡∂±‡∑ê‡∑Ñ‡∑ê.": "‡∂∏‡∂Ç ‡∂Ø‡∂±‡∑ä‡∂±‡∑ô ‡∂±‡∑ë.", "‡∂î‡∂∂ ‡∂ö‡∑î‡∂∏‡∂ö‡∑ä‡∂Ø ‡∂ö‡∑Ö‡∑ö?": "‡∂Ö‡∂∫‡∑í‡∂∫‡∑ù, ‡∂∏‡∑ú‡∂ö‡∂ö‡∑ä‡∂Ø ‡∂∏‡∑ö ‡∂ö‡∂ª‡∂ú‡∂≠‡∑ä‡∂≠‡∑ô?",
    "‡∂±‡∑í‡∂ö‡∂∏‡∑ä‡∂∏ ‡∂±‡∂©‡∑î‡∑Ä‡∂ö‡∂Ø‡∑ì.": "‡∑É‡∑ê‡∂ö‡∑ö‡∂ß‡∂≠‡∑ä ‡∂ë‡∂ö‡∑ä‡∂ö.", "‡∂∏‡∂∏ ‡∂∏‡∂ú‡∑ö ‡∂ú‡∂∏‡∂±‡∑ö.": "‡∂∏‡∂∏ ‡∂∏‡∑ö ‡∂ë‡∂± ‡∂ú‡∂∏‡∂±‡∑ä.",
    "‡∂ë‡∂∫ ‡∂î‡∂∂‡∂ß ‡∂∑‡∑è‡∂ª‡∂∫‡∑í.": "‡∂í‡∂ö ‡∂î‡∂∫‡∑è‡∂ú‡∑ö ‡∑Ä‡∑ê‡∂©‡∂ö‡∑ä.", "‡∂í ‡∂ú‡∑ê‡∂± ‡∑É‡∑ê‡∂ö‡∂∫‡∂ö‡∑ä ‡∂±‡∑ê‡∑Ñ‡∑ê": "‡∂Ö‡∂±‡∑í‡∑Ä‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∑ô‡∂±‡∑ä‡∂∏",
    "‡∂î‡∑Ñ‡∑î‡∂ß ‡∂ú‡∂Ω‡∑ä ‡∑Ñ‡∂Ø‡∑Ä‡∂≠‡∂ö‡∑ä ‡∂á‡∂≠": "‡∂å‡∂ß ‡∂ö‡∑í‡∑É‡∑í‡∂∏ ‡∑Ñ‡∑í‡∂≠‡∂ö‡∑ä ‡∂¥‡∂¥‡∑î‡∑Ä‡∂ö‡∑ä ‡∂±‡∑ë", "‡∂î‡∂∂ ‡∑Ñ‡∑ú‡∂≥‡∑í‡∂±‡∑ä ‡∑É‡∑Ä‡∂±‡∑ä ‡∂Ø‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í.": "‡∂∏‡∂∏ ‡∂ö‡∑í‡∂∫‡∂± ‡∂Ø‡∑ö ‡∑Ñ‡∑ú‡∂≥‡∂ß ‡∂Ö‡∑Ñ‡∂ú‡∂±‡∑ä‡∂±‡∑Ä‡∑è.",
    "‡∂∂‡∑ú‡∑Ñ‡∑ù ‡∂ö‡∂Ω‡∂ö‡∂ß ‡∂¥‡∑ô‡∂ª": "‡∂ö‡∑è‡∂Ω‡∑ô‡∂ö‡∂ß ‡∂â‡∑É‡∑ä‡∑É‡∂ª", "‡∂ú‡∂Ω‡∑ä ‡∑Ä‡∂Ω‡∂ß ‡∂Ü‡∂Ø‡∂ª‡∑ô‡∂∫‡∑í": "‡∂ú‡∂Ω‡∑ä ‡∑Ä‡∂Ω‡∂ß ‡∂Ü‡∑É‡∂∫‡∑í",
    "‡∂î‡∑Ä‡∑î‡∂±‡∑ä ‡∂∏‡∑ú‡∑Ö ‡∂ö‡∑ë‡∂∏‡∂ß ‡∂ö‡∑ê‡∂∏‡∂≠‡∑í‡∂∫‡∑í": "‡∂ã‡∂±‡∑ä ‡∂Ü‡∑É ‡∂∏‡∑ú‡∂Ω‡∑ö ‡∂ö‡∂±‡∑ä‡∂±", "‡∂í‡∂ö ‡∂Ø‡∑í‡∂ú ‡∂ö‡∑è‡∂Ω‡∂∫‡∂ö‡∑ä": "‡∂í‡∂ö ‡∂±‡∂∏‡∑ä ‡∂Ω‡∑ú‡∂ö‡∑î ‡∂ö‡∑è‡∂Ω‡∂∫‡∂ö‡∑ä ‡∂≠‡∂∏‡∂∫‡∑í",
    "‡∂â‡∂≠‡∑í‡∂±‡∑ä ‡∂î‡∂∂ ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂±‡∑ö": "‡∂â‡∂≠‡∑í‡∂±‡∑ä ‡∂ã‡∂π ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂±‡∑ô", "‡∑É‡∑ô‡∂±‡∑ù‡∂ª‡∑ä, ‡∂¥‡∂ß‡∂±‡∑ä ‡∂ú‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è.": "‡∑É‡∑ô‡∂±‡∑ù‡∂ª‡∑ä, ‡∂ï‡∂ö ‡∂¥‡∂ß‡∂±‡∑ä ‡∂ú‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è.",
    "‡∂Ö‡∑Ä‡∑î‡∂ª‡∑î‡∂Ø‡∑î ‡∂¥‡∑Ñ‡∂ö‡∂ß, ‡∑Ñ‡∑è‡∑Ñ‡∑ä?": "‡∂Ö‡∑Ä‡∑î‡∂ª‡∑î‡∂Ø‡∑î ‡∂¥‡∑Ñ‡∂ö‡∑ä ‡∂≠‡∑í‡∑É‡∑ä‡∑É‡∑ö, ‡∂à?", "‡∂∏‡∂∏ ‡∂Ö‡∂∏‡∑î‡∂Ω‡∑ä.": "‡∂∏‡∂ú‡∑ö ‡∂±‡∂∏ ‡∂±‡∂Ω‡∑ä.",
    "‡∂∂‡∂Ω‡∑ä‡∂Ω‡∑ú‡∂∫‡∑í ‡∂¥‡∑ñ‡∑É‡∑ú‡∂∫‡∑í ‡∑Ä‡∑Ñ‡∑í‡∂±‡∑Ä‡∑è": "‡∑Ñ‡∑ú‡∂≥‡∂ß‡∂∏ ‡∑Ä‡∑Ñ‡∑í‡∂±‡∑Ä‡∑è", "‡∂ö‡∂ö‡∑î‡∂Ω‡∂ö‡∑ä ‡∂ö‡∂©‡∑è‡∂ú‡∂±‡∑ä‡∂±": "‡∂¢‡∂∫ ‡∑Ä‡∑ö‡∑Ä‡∑è!",
    "‡∂∂‡∑ù‡∂Ç‡∂†‡∑í ‡∑Ñ‡∂Ω‡∂±‡∑ä‡∂±": "‡∂á‡∂≠‡∑ä‡∂≠ ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂±", "‡∂ã‡∂´‡∑ä‡∂©‡∂∫ ‡∑Ñ‡∂¥‡∂±‡∑ä‡∂±": "‡∂Ö‡∂∏‡∑è‡∂ª‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∑Ñ‡∂ª‡∑í ‡∂∏‡∑ñ‡∂´ ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±",
    "‡∂±‡∑í‡∂Ω‡∑ä ‡∑Ñ‡∂≥‡∂ö ‡∑Ä‡∂ª‡∂ö‡∑ä": "‡∂ö‡∂Ω‡∑è‡∂≠‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä", "‡∂î‡∂∂ ‡∂á‡∂´‡∂∫‡∑ö ‡∑Ñ‡∑í‡∑É‡∂ß ‡∂ú‡∑ê‡∑Ñ‡∑î‡∑Ä‡∑è": "‡∂î‡∂∫‡∑è ‡∂ö‡∑í‡∑Ä‡∑ä‡∑Ä‡∑ö ‡∑Ñ‡∂ª‡∑í‡∂∫‡∂ß‡∂∏ ‡∑Ñ‡∂ª‡∑í",
    "‡∂∏‡∂ß ‡∂ö‡∑è‡∂Ω‡∂ú‡∑î‡∂´‡∂∫ ‡∂∫‡∂ß‡∂≠‡∑ö ‡∂Ø‡∑ê‡∂±‡∑ô‡∂±‡∑Ä‡∑è": "‡∂∏‡∂ß ‡∂ß‡∑í‡∂ö‡∂ö‡∑ä ‡∂Ö‡∑É‡∂±‡∑ì‡∂¥‡∂∫‡∑í", "‡∂î‡∂∂ ‡∂∏‡∂ú‡∑ö ‡∂ö‡∂ö‡∑î‡∂Ω ‡∂Ö‡∂Ø‡∑í‡∂±‡∑Ä‡∑è": "‡∂î‡∂∫‡∑è ‡∂∏‡∑è‡∑Ä ‡∂Ö‡∂±‡∑ä‡∂Ø‡∂±‡∑ä‡∂± ‡∑Ñ‡∂Ø‡∂±‡∑ä‡∂±‡∑ö",
    "‡∂ë‡∂∫ ‡∂ª‡∑ú‡∂ö‡∂ß‡∑ä ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∑Ä ‡∂±‡∑ú‡∑Ä‡∑ö": "‡∂í‡∂ö ‡∂ë‡∂†‡∑ä‡∂†‡∂ª ‡∂Ω‡∑ú‡∂ö‡∑î ‡∂Ø‡∑ô‡∂∫‡∂ö‡∑ä ‡∂±‡∑ô‡∑Ä‡∑ô‡∂∫‡∑í", "‡∂Ö‡∂¥‡∑í ‡∂ë‡∂∫ ‡∂Ø‡∑Ä‡∑É‡∂ö‡∑ä ‡∂Ω‡∑ô‡∑É ‡∑Ñ‡∂≥‡∑î‡∂±‡∑ä‡∑Ä‡∂∏‡∑î": "‡∂Ö‡∂Ø‡∂ß ‡∑Ä‡∑ê‡∂© ‡∂á‡∂≠‡∑í"
}

# ==========================================================
# ‡∂∏‡∑ú‡∑Ö‡∂∫ 2: ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂ö‡∂ª‡∂´ ‡∂ú‡∑î‡∂ª‡∑î‡∂≠‡∑î‡∂∏‡∑è (‡∂∂‡∑î‡∂Ø‡∑ä‡∂∞‡∑í‡∂∏‡∂≠‡∑ä ‡∂ª‡∑ì‡∂≠‡∑í ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫)
# ==========================================================
def apply_intelligent_rules(text):
    original_text = text
    # ‡∂ª‡∑ì‡∂≠‡∑í‡∂∫ 1: "‡∂∏‡∂∏ [‡∂±‡∂∏]." -> "‡∂∏‡∂ú‡∑ö ‡∂±‡∂∏ [‡∂±‡∂∏]."
    pattern1 = r"^‡∂∏‡∂∏\s+([\w\']+)\.?$"
    if re.search(pattern1, text): return f"‡∂∏‡∂ú‡∑ö ‡∂±‡∂∏ {re.search(pattern1, text).group(1)}."
    # ‡∂ª‡∑ì‡∂≠‡∑í‡∂∫ 2: "‡∂î‡∂∂ [‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç‡∂´‡∂∫‡∂ö‡∑ä]‡∂ß ‡∂¥‡∑ô‡∂±‡∑ö." -> "‡∂î‡∂∂ [‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç‡∂´‡∂∫‡∂ö‡∑ä]‡∂∫‡∑í."
    pattern2 = r"^(‡∂î‡∂∂|‡∂î‡∂∫‡∑è)\s+(.+?)‡∂ß\s+(‡∂¥‡∑ô‡∂±‡∑ö|‡∂¥‡∑ö‡∂±‡∑Ä‡∑è)\.?$"
    if re.search(pattern2, text): return f"{re.search(pattern2, text).group(1)} {re.search(pattern2, text).group(2)}‡∂∫‡∑í."
    # ‡∂ª‡∑ì‡∂≠‡∑í‡∂∫ 3: "‡∂î‡∂∂ ‡∑É‡∑í‡∂≠‡∂±‡∑Ä‡∑è‡∂Ø [‡∂ö‡∑è‡∂ª‡∂´‡∂∫] ‡∂ö‡∑í‡∂∫‡∑è?" -> "[‡∂ö‡∑è‡∂ª‡∂´‡∂∫] ‡∂ö‡∑í‡∂∫‡∂Ω‡∂Ø ‡∑Ñ‡∑í‡∂≠‡∑î‡∑Ä‡∑ö?"
    pattern3 = r"^(‡∂î‡∂∂ ‡∑É‡∑í‡∂≠‡∂±‡∑Ä‡∑è‡∂Ø|‡∂î‡∂∫‡∑è ‡∑Ñ‡∑í‡∂≠‡∂±‡∑Ä‡∂Ø)\s+(.+?)\s+‡∂ö‡∑í‡∂∫‡∑è\?$"
    if re.search(pattern3, text): return f"{re.search(pattern3, text).group(2)} ‡∂ö‡∑í‡∂∫‡∂Ω‡∂Ø ‡∑Ñ‡∑í‡∂≠‡∑î‡∑Ä‡∑ö?"
    # ‡∂ª‡∑ì‡∂≠‡∑í‡∂∫ 4: "‡∂ë‡∂∫ [‡∂ö‡∑è‡∂ú‡∑ö‡∑Ñ‡∂ª‡∑í] [‡∂Ø‡∑ô‡∂∫‡∂ö‡∑ä]‡∂∫‡∑í." -> "‡∂í‡∂ö [‡∂ö‡∑è‡∂ú‡∑ö‡∑Ñ‡∂ª‡∑í] [‡∂Ø‡∑ô‡∂∫‡∂ö‡∑ä]‡∂ö‡∑ä."
    pattern4 = r"^‡∂ë‡∂∫\s+(.+?)(‡∂ú‡∑ö|‡∂ú‡∑ô)\s+(.+?)‡∂∫‡∑í\.?$"
    if re.search(pattern4, text): return f"‡∂í‡∂ö {re.search(pattern4, text).group(1)}‡∂ú‡∑ö {re.search(pattern4, text).group(3)}‡∂ö‡∑ä."
    return original_text

# ==========================================================
# ‡∂∏‡∑ú‡∑Ö‡∂∫ 3: ‡∂ö‡∂Ω‡∑è‡∂ö‡∂ª‡∑î‡∑Ä‡∑è (‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∑Å‡∑ì‡∂Ω‡∑ì ‡∂ª‡∑ì‡∂≠‡∑í ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫)
# ==========================================================
creative_dictionary = {
    "‡∂∏‡∂ß ‡∂î‡∂∂‡∑Ä ‡∂∏‡∂ú‡∑Ñ‡∂ª‡∑Ä‡∑è ‡∂ú‡∂±‡∑ä‡∂±‡∑ô‡∂∏‡∑í.": ["‡∂∏‡∂ß ‡∂î‡∂∫‡∑è‡∑Ä ‡∂±‡∑ê‡∂≠‡∑î‡∑Ä ‡∂¥‡∑è‡∑Ö‡∑î ‡∑Ñ‡∑í‡∂≠‡∑ô‡∂∫‡∑í.", "‡∂∏‡∂ß ‡∂î‡∂∫‡∑è‡∑Ä ‡∂∏‡∂≠‡∂ö‡∑ä ‡∑Ä‡∑ô‡∂±‡∑Ä‡∑è."],
    "‡∂Ö‡∂¥‡∑í ‡∂∏‡∑ô‡∂≠‡∂±‡∑í‡∂±‡∑ä ‡∂∫‡∂∏‡∑î.": ["‡∂∫‡∂∏‡∑î ‡∂∏‡∑ô‡∑Ñ‡∑ô‡∂±‡∑ä.", "‡∂∏‡∑ô‡∂≠‡∂±‡∑í‡∂±‡∑ä ‡∂∫‡∂∏‡∑î."],
    "‡∂î‡∂∂ ‡∂î‡∂∂‡∑ö ‡∂∏‡∂±‡∑É‡∑í‡∂±‡∑ä ‡∂∂‡∑ê‡∑Ñ‡∑ê‡∂ª‡∂Ø?": ["‡∂î‡∂∫‡∑è‡∂ß ‡∑É‡∑í‡∑Ñ‡∑í‡∂∫‡∂ö‡∑ä ‡∂±‡∑ê‡∂Ø‡∑ä‡∂Ø?", "‡∂î‡∂∫‡∑è‡∂ß ‡∂¥‡∑í‡∑É‡∑ä‡∑É‡∑î‡∂Ø?"],
    "‡∂í ‡∂ú‡∑ê‡∂± ‡∂∏‡∂ß ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂±.": ["‡∂Ö‡∑Ñ‡∂±‡∑ä‡∂±‡∂≠‡∑ä ‡∂Ø‡∑ô‡∂∫‡∂ö‡∑ä‡∂Ø.", "‡∂í‡∂ö ‡∂≠‡∂∏‡∂∫‡∑í ‡∂∏‡∂∏ ‡∂∏‡∑ö ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂±‡∑ô‡∂≠‡∑ä."],
    "‡∂î‡∂∂ ‡∂∂‡∂ª‡∂¥‡∂≠‡∂Ω‡∂Ø?": ["‡∂á‡∂≠‡∑ä‡∂≠‡∂∏‡∂Ø ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂±‡∑ô?", "‡∑Ä‡∑í‡∂ö‡∑è‡∂ª‡∂Ø?"], "‡∂ë‡∂±‡∑ä‡∂±!": ["‡∑Ñ‡∑ö‡∂∫‡∑í, ‡∂ë‡∂±‡∑ä‡∂±‡∂ö‡∑ù!", "‡∂±‡∑í‡∂ö‡∂±‡∑ä ‡∂â‡∂±‡∑ä‡∂±‡∑Ä‡∂ö‡∑ú!"],
    "‡∂î‡∂∂ ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ª‡∑ä‡∂Æ‡∂±‡∑è ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è!": ["‡∑Ñ‡∑ì‡∂±‡∑ô‡∂±‡∑ä ‡∂≠‡∂∏‡∂∫‡∑í!", "‡∑Ñ‡∑í‡∂≠‡∑è‡∂ú‡∑ô‡∂± ‡∂â‡∂±‡∑ä‡∂±."],
    "‡∂∏‡∂ß ‡∑Ä‡∑í‡∑Ä‡∑ö‡∂ö‡∂∫‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±!": ["‡∑Ä‡∑í‡∂ö‡∑è‡∂ª ‡∂ö‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è!", "‡∂Ö‡∂±‡∑ö ‡∂±‡∑í‡∂ö‡∂±‡∑ä ‡∂â‡∂±‡∑ä‡∂±‡∑Ä‡∂ö‡∑ú!"],
    "‡∂î‡∂∂‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‡∂∫ ‡∂ö‡∑î‡∂∏‡∂ö‡∑ä‡∂Ø?": ["‡∂∏‡∑ú‡∂ö‡∂Ø ‡∂ï‡∂±‡∑ô?", "‡∂î‡∂∫‡∑è‡∂ß ‡∂∏‡∑ú‡∂±‡∑Ä‡∂Ø ‡∂ï‡∂±‡∑ô?"], "‡∂ë‡∑É‡∑ö ‡∂Ø?": ["‡∂ë‡∑Ñ‡∑ô‡∂∏‡∂Ø?", "‡∂á‡∂≠‡∑ä‡∂≠‡∂Ø?"],
    "‡∂ö‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∑Ñ‡∑ê.": ["‡∂ï‡∂ö ‡∂Ö‡∂∏‡∂≠‡∂ö ‡∂ö‡∂ª‡∂Ω‡∑è ‡∂Ø‡∑è‡∂±‡∑ä‡∂±.", "‡∂ú‡∂±‡∂±‡∑ä ‡∂ú‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è."], "‡∂â‡∂≠‡∑í‡∂±‡∑ä ‡∂ö‡∑î‡∂∏‡∂ö‡∑ä ‡∂Ø?": ["‡∂â‡∂≠‡∑í‡∂±‡∑ä ‡∂∏‡∑ú‡∂ö‡∑ù?", "‡∂∏‡∂ß ‡∂∏‡∑ú‡∂ö‡∑ù?"],
    "‡∂∏‡∂ß ‡∑Ä‡∑í‡∑Å‡∑ä‡∑Ä‡∑è‡∑É ‡∂±‡∑ë.": ["‡∂∏‡∂ß ‡∂±‡∂∏‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∑Ä‡∑è‡∑É ‡∂±‡∑ë.", "‡∑Ñ‡∂ª‡∑í‡∂∫‡∂ß‡∂∏ ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂± ‡∂∂‡∑ë."],
    "‡∂ö‡∑í‡∑É‡∑í‡∂∏ ‡¥µ‡¥¥‡∑í‡∂∫‡∂ö‡∑ä ‡∂±‡∑ê‡∑Ñ‡∑ê!": ["‡∂Ö‡∂¥‡∑ù ‡∂∂‡∑ë!", "‡∑Ä‡∑ô‡∂±‡∑ä‡∂± ‡∂∂‡∑ë!"], "‡∂∏‡∂∏ ‡∂ë‡∑É‡∑ö ‡∂Ö‡∂±‡∑î‡∂∏‡∑è‡∂± ‡∂ö‡∂ª‡∂∏‡∑í.": ["‡∑Ä‡∑ô‡∂±‡∑ä‡∂± ‡∂á‡∂≠‡∑í.", "‡∂ë‡∑Ñ‡∑ô‡∂∏ ‡∂≠‡∂∏‡∂∫‡∑í ‡∂¥‡∑ö‡∂±‡∑ä‡∂±‡∑ô."],
    "‡∂í‡∂ö ‡∂∏‡∂ú‡∑ö ‡∑Ä‡∂ª‡∂Ø‡∂ö‡∑ä.": ["‡∑Ä‡∑ê‡∂ª‡∑ê‡∂Ø‡∑ä‡∂Ø ‡∂∏‡∂ú‡∑ö.", "‡∑É‡∂∏‡∑è‡∑Ä‡∑ô‡∂±‡∑ä‡∂±, ‡∂í‡∂ö ‡∂∏‡∂ú‡∑ö ‡∂Ö‡∂≠‡∑í‡∂±‡∑ä ‡∑Ä‡∑î‡∂´‡∑ö."], "‡∑Ñ‡∂ª‡∑í.": ["‡∑Ñ‡∂ª‡∑í ‡∑Ñ‡∂ª‡∑í.", "‡∑Ñ‡∂ª‡∑í."]
}
def apply_creative_rules(text):
    stripped_text = text.strip()
    if stripped_text in creative_dictionary:
        options = creative_dictionary[stripped_text]
        return random.choice(options) if isinstance(options, list) else options
    return text

# ==========================================================
# ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ë‡∂±‡∑ä‡∂¢‡∑í‡∂∏ (Core Engine)
# ==========================================================
def process_srt_content(english_content):
    try:
        credentials = service_account.Credentials.from_service_account_info(st.secrets["gcp_service_account"])
        translate_client = translate.Client(credentials=credentials)
        blocks = english_content.strip().split('\n\n')
        dialogues_to_translate = {i: ("\n".join(b.strip().splitlines()[2:])) for i, b in enumerate(blocks) if len(b.strip().splitlines()) > 2 and any(c.isalpha() for c in "\n".join(b.strip().splitlines()[2:]))}
        
        if not dialogues_to_translate:
            st.warning("‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ø‡∑ô‡∂∂‡∑É‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫.")
            return english_content

        dialogue_list = list(dialogues_to_translate.values())
        original_indices = list(dialogues_to_translate.keys())
        
        batch_size = 128
        all_translated_texts = []
        for i in range(0, len(dialogue_list), batch_size):
            batch = dialogue_list[i:i + batch_size]
            results = translate_client.translate(batch, target_language='si', format_='text')
            all_translated_texts.extend([res['translatedText'] for res in results])

        translated_dialogues = {original_indices[i]: all_translated_texts[i] for i in range(len(all_translated_texts))}
        
        final_blocks = list(blocks)
        for index, raw_translated in translated_dialogues.items():
            header_lines = final_blocks[index].strip().splitlines()[:2]
            header = "\n".join(header_lines)
            
            knowledge_applied = raw_translated
            for bad, good in correction_rules.items():
                knowledge_applied = knowledge_applied.replace(bad, good)

            intelligent_applied = "\n".join([apply_intelligent_rules(line) for line in knowledge_applied.splitlines()])
            creative_applied = apply_creative_rules(intelligent_applied)
            final_blocks[index] = header + '\n' + creative_applied

        return "\n\n".join(final_blocks)
    except Exception as e:
        st.error(f"‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∂∂‡∂ª‡∂¥‡∂≠‡∂Ω ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑í‡∑Ä‡∑í‡∂∫: {e}")
        return None

# ==========================================================
# UI (‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂Ö‡∂≠‡∑î‡∂ª‡∑î‡∂∏‡∑î‡∑Ñ‡∑î‡∂´‡∂≠)
# ==========================================================
st.set_page_config(page_title="‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∑É‡∂ö‡∑É‡∂±‡∂∫", page_icon="üìù", layout="wide")
st.title("üìù ‡∑É‡∂ª‡∂Ω ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∑É‡∂ö‡∑É‡∂±‡∂∫ v16.0 (Unified Core)")

if 'translated_content' not in st.session_state: st.session_state.translated_content = None
if 'original_content' not in st.session_state: st.session_state.original_content = None
if 'file_name' not in st.session_state: st.session_state.file_name = "edited_subtitle.srt"

uploaded_file = st.file_uploader("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 1: ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í .srt ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö Upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±", type=['srt'])
if uploaded_file is not None:
    english_content = uploaded_file.getvalue().decode("utf-8")
    st.session_state.original_content = english_content
    st.session_state.file_name = uploaded_file.name
    if st.button("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 2: ‚ú® ‡∂Ø‡∑ê‡∂±‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"):
        with st.spinner("AI ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì..."):
            final_content = process_srt_content(english_content)
        if final_content:
            st.session_state.translated_content = final_content
            st.balloons()

if st.session_state.translated_content:
    st.subheader("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 3: ‡∑É‡∂¢‡∑ì‡∑Ä‡∑ì‡∑Ä ‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª ‡∂∂‡∑è‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±")
    original_blocks = st.session_state.original_content.strip().split('\n\n')
    translated_blocks = st.session_state.translated_content.strip().split('\n\n')
    min_blocks = min(len(original_blocks), len(translated_blocks))
    for i in range(min_blocks):
        col1, col2 = st.columns(2)
        with col1:
            st.text_area(f"‡∂∏‡∑î‡∂Ω‡∑ä ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í ‡∂Ø‡∑ô‡∂∂‡∑É #{i+1}", value=original_blocks[i], height=120, key=f"orig_{i}", disabled=True)
        with col2:
            st.text_area(f"AI ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ #{i+1}", value=translated_blocks[i], height=120, key=f"edit_{i}")
    st.subheader("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 4: ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í‡∂∫ ‡∂∂‡∑è‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±")
    final_edited_blocks = [st.session_state[f"edit_{i}"] for i in range(min_blocks)]
    final_edited_content = "\n\n".join(final_edited_blocks)
    st.download_button("üì• ‡∂∂‡∑è‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±", data=final_edited_content.encode('utf-8'), file_name=f"edited_sinhala_{st.session_state.file_name}")
