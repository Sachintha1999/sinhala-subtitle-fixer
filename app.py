# -*- coding: utf-8 -*-

import streamlit as st
from deep_translator import GoogleTranslator
import re

# --- ‡∂Ö‡∂¥‡∑ö ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ (Knowledge Base v0.1) ---
correction_rules = {
    "‡∂∂‡∂Ω‡∑ä‡∂Ω‡∑ú‡∂∫‡∑í ‡∂¥‡∑ñ‡∑É‡∑ú‡∂∫‡∑í ‡∑Ä‡∑Ñ‡∑í‡∂±‡∑Ä‡∑è": "‡∑Ñ‡∑ú‡∂≥‡∂ß‡∂∏ ‡∑Ä‡∑Ñ‡∑í‡∂±‡∑Ä‡∑è",
    "‡∂ö‡∂ö‡∑î‡∂Ω‡∂ö‡∑ä ‡∂ö‡∂©‡∑è‡∂ú‡∂±‡∑ä‡∂±": "‡∂¢‡∂∫ ‡∑Ä‡∑ö‡∑Ä‡∑è!",
    "‡∂∂‡∑ù‡∂Ç‡∂†‡∑í ‡∑Ñ‡∂Ω‡∂±‡∑ä‡∂±": "‡∂á‡∂≠‡∑ä‡∂≠ ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂±",
    "‡∂ã‡∂´‡∑ä‡∂©‡∂∫ ‡∑Ñ‡∂¥‡∂±‡∑ä‡∂±": "‡∂Ö‡∂∏‡∑è‡∂ª‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∑Ñ‡∂ª‡∑í ‡∂∏‡∑ñ‡∂´ ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±",
    "‡∂±‡∑í‡∂Ω‡∑ä ‡∑Ñ‡∂≥‡∂ö ‡∑Ä‡∂ª‡∂ö‡∑ä": "‡∂ö‡∂Ω‡∑è‡∂≠‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä",
    "‡∂î‡∂∂ ‡∂á‡∂´‡∂∫‡∑ö ‡∑Ñ‡∑í‡∑É‡∂ß ‡∂ú‡∑ê‡∑Ñ‡∑î‡∑Ä‡∑è": "‡∂î‡∂∫‡∑è ‡∂ö‡∑í‡∑Ä‡∑ä‡∑Ä‡∑ö ‡∑Ñ‡∂ª‡∑í‡∂∫‡∂ß‡∂∏ ‡∑Ñ‡∂ª‡∑í",
    "‡∂∏‡∂ß ‡∂ö‡∑è‡∂Ω‡∂ú‡∑î‡∂´‡∂∫ ‡∂∫‡∂ß‡∂≠‡∑ö ‡∂Ø‡∑ê‡∂±‡∑ô‡∂±‡∑Ä‡∑è": "‡∂∏‡∂ß ‡∂ß‡∑í‡∂ö‡∂ö‡∑ä ‡∂Ö‡∑É‡∂±‡∑ì‡∂¥‡∂∫‡∑í"
    # ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂í‡∑Ä‡∑è ‡∂∏‡∑ô‡∂≠‡∂±‡∂ß ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
}

def fix_sinhala_content(sinhala_content):
    """‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑Ö ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫ ‡∂Ö‡∂ª‡∂ú‡∑ô‡∂±, ‡∂Ö‡∂¥‡∑ö ‡∂ª‡∑ñ‡∂Ω‡∑ä‡∑É‡∑ä ‡∑Ä‡∂Ω‡∂ß ‡∂Ö‡∂±‡∑î‡∑Ä ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∂ª‡∂± function ‡∂ë‡∂ö."""
    lines = sinhala_content.splitlines()
    corrected_lines = []
    for line in lines:
        corrected_line = line
        for bad_phrase, good_phrase in correction_rules.items():
            if bad_phrase in corrected_line:
                corrected_line = corrected_line.replace(bad_phrase, good_phrase)
        corrected_lines.append(corrected_line)
    return "\n".join(corrected_lines)

def translate_and_fix(english_content):
    """‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫ ‡∂Ö‡∂ª‡∂ú‡∑ô‡∂±, ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä ‡∑Ä‡∂Ω‡∂ß ‡∂ö‡∂©‡∂Ω‡∑è, ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∂ß ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª, ‡∂¥‡∑É‡∑î‡∑Ä ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∂ª‡∂± function ‡∂ë‡∂ö."""
    try:
        # ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫
        translator = GoogleTranslator(source='en', target='si')
        
        # SRT file ‡∂ë‡∂ö‡∑ö text ‡∂±‡∑ú‡∑Ä‡∂± ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä (‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∏‡∑ä, ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä) ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂±‡∑ú‡∑Ä‡∑ì ‡∂≠‡∑í‡∂∫‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß
        # ‡∂Ö‡∂¥‡∑í text ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä ‡∑Ä‡∑í‡∂≠‡∂ª‡∂ö‡∑ä ‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±‡∑Ä‡∑è
        lines = english_content.splitlines()
        final_lines = []
        text_to_translate = []

        for line in lines:
            # ‡∂∏‡∑ö‡∑Ä‡∑è text ‡∂±‡∑ô‡∑Ä‡∑ô‡∂∫‡∑í, ‡∂í ‡∂±‡∑í‡∑É‡∑è ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂±‡∑ë
            if re.match(r'^\d+$', line) or '-->' in line or line.strip() == '':
                final_lines.append(line)
            else:
                # ‡∂∏‡∑ö‡∑Ä‡∑è text, ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂ï‡∂±
                # ‡∂Ö‡∂¥‡∑í placeholder ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑è‡∂Ω‡∑è, text ‡∂ß‡∑í‡∂ö ‡∑Ä‡∑ô‡∂±‡∂∏ list ‡∂ë‡∂ö‡∂ö‡∂ß ‡∂Ø‡∑è‡∂ú‡∂±‡∑ä‡∂±‡∑Ä‡∑è
                final_lines.append("___TEXT___") 
                text_to_translate.append(line)
        
        # ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂ú‡∂≠‡∑ä text ‡∂ß‡∑í‡∂ö ‡∂ë‡∂ö ‡∂Ø‡∑í‡∂ú‡∂ß ‡∂≠‡∑í‡∂∫‡∂Ω‡∑è, ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä ‡∑Ä‡∂Ω‡∂ß ‡∂ö‡∂©‡∂Ω‡∑è ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è
        full_text = "\n".join(text_to_translate)
        translated_text = translator.translate(full_text)
        
        # ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂¥‡∑î text ‡∂ß‡∑í‡∂ö ‡∂Ü‡∂∫‡∑ô‡∂≠‡∑ä lines ‡∑Ä‡∂Ω‡∂ß ‡∂ö‡∂©‡∂±‡∑Ä‡∑è
        translated_lines = translated_text.splitlines()
        
        # ‡∂Ø‡∑ê‡∂±‡∑ä placeholder ‡∂≠‡∑í‡∂∂‡∑ä‡∂∂ ‡∂≠‡∑ê‡∂±‡∑ä ‡∑Ä‡∂Ω‡∂ß, ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂¥‡∑î text ‡∂ß‡∑í‡∂ö ‡∂Ü‡∂Ø‡∑ö‡∑Å ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è
        translated_iterator = iter(translated_lines)
        for i in range(len(final_lines)):
            if final_lines[i] == "___TEXT___":
                try:
                    final_lines[i] = next(translated_iterator)
                except StopIteration:
                    final_lines[i] = "" # ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫‡∑ö‡∂Ø‡∑ì ‡∂¥‡∑ö‡∑Ö‡∑í ‡∂Ö‡∂©‡∑î ‡∑Ä‡∑î‡∂´‡∑ú‡∂≠‡∑ä ‡∑Ñ‡∑í‡∑É‡∑ä ‡∂¥‡∑ö‡∑Ö‡∑í‡∂∫‡∂ö‡∑ä ‡∂Ø‡∑è‡∂±‡∑Ä‡∑è
        
        sinhala_content = "\n".join(final_lines)

        # ‡∂Ö‡∂¥‡∑ö ‡∑É‡∑í‡∑É‡∑ä‡∂ß‡∂∏‡∑ä ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        fixed_content = fix_sinhala_content(sinhala_content)
        return fixed_content

    except Exception as e:
        return f"‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑í‡∑Ä‡∑í‡∂∫: {e}"

# --- Web App ‡∂ë‡∂ö‡∑ö ‡∂¥‡∑ô‡∂±‡∑î‡∂∏ ‡∑Ñ‡∂Ø‡∂± ‡∂≠‡∑ê‡∂± ---
st.set_page_config(page_title="‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∑É‡∂ö‡∑É‡∂±‡∂∫", page_icon="üìù")
st.title("üìù ‡∑É‡∂ª‡∂Ω ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∑É‡∂ö‡∑É‡∂±‡∂∫ v3.0 (‡∂∂‡∑î‡∂Ø‡∑ä‡∂∞‡∑í‡∂∏‡∂≠‡∑ä)")
st.markdown("‡∂î‡∂∂‡∂ú‡∑ö ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∂ú‡∑ú‡∂±‡∑î‡∑Ä ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑ô‡∂±‡∑ä‡∂±. ‡∂ë‡∂∫ ‡∑É‡∑ä‡∑Ä‡∂∫‡∂Ç‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∫‡∑Ä ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∂ß ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª, ‡∂ë‡∑Ñ‡∑í ‡∂á‡∂≠‡∑í ‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∑ò‡∂≠‡∑í‡∂ö‡∂∏‡∂∫ ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∂ª ‡∂î‡∂∂‡∂ß ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑ô‡∂±‡∑î ‡∂á‡∂≠.")

st.subheader("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 1: ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í `.srt` ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö Upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±")
uploaded_file = st.file_uploader("‡∂î‡∂∂‡∂ú‡∑ö ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í .srt ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±", type=['srt'])

if uploaded_file is not None:
    st.success(f"'{uploaded_file.name}' ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂Ω‡∑ê‡∂∂‡∑î‡∂±‡∑í.")
    english_content = uploaded_file.getvalue().decode("utf-8")
    
    st.subheader("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 2: ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∂ª‡∂±‡∑ä‡∂±")
    
    if st.button("‚ú® ‡∂Ø‡∑ê‡∂±‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"):
        with st.spinner("‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í‡∂∫ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä..."):
            final_content = translate_and_fix(english_content)
        
        st.success("‡∂±‡∑í‡∂∫‡∂∏‡∂∫‡∑í! ‡∂î‡∂∂‡∂ú‡∑ö ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í‡∂∫ ‡∑É‡∂ö‡∑É‡∑è ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä.")
        st.subheader("‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂µ‡∂Ω‡∂∫: ‡∑É‡∂ö‡∑É‡∂± ‡∂Ω‡∂Ø ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö Download ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±")
        
        st.download_button(
           label="üì• ‡∑É‡∂ö‡∑É‡∂± ‡∂Ω‡∂Ø ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∂∏‡∑ô‡∂≠‡∂±‡∑í‡∂±‡∑ä ‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±",
           data=final_content.encode('utf-8'), # UTF-8 encoding ‡∂ë‡∂ö ‡∑Ñ‡∂ª‡∑í‡∂∫‡∂ß‡∂∏ ‡∂Ø‡∑è‡∂±‡∑Ä‡∑è
           file_name=f"fixed_sinhala_{uploaded_file.name}",
           mime="text/plain"
        )
