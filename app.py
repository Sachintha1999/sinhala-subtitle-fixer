# -*- coding: utf-8 -*-

import streamlit as st
from deep_translator import GoogleTranslator
import time # Progress bar ‡∂ë‡∂ö‡∂ß ‡∂¥‡∑ú‡∂©‡∑í delay ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±

# --- ‡∂Ö‡∂¥‡∑ö ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ (Knowledge Base) ---
# ‡∂Ö‡∂±‡∑è‡∂ú‡∂≠‡∂∫‡∑ö‡∂Ø‡∑ì ‡∂Ö‡∂¥‡∑í‡∂ß ‡∂∏‡∑ô‡∂≠‡∂±‡∂ß ‡∑Ä‡∂†‡∂± ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂¥‡∑î‡∑Ö‡∑î‡∑Ä‡∂±‡∑ä
correction_rules = {}

def translate_srt_block(block, translator):
    """SRT ‡∂ë‡∂ö‡∂ö ‡∂≠‡∂±‡∑í ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ö‡∂ª‡∂ú‡∑ô‡∂± ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂∫‡∑í"""
    if not block.strip():
        return ""
    
    lines = block.strip().splitlines()
    if len(lines) < 2:
        return block 

    header = lines[0] + '\n' + lines[1]
    dialogue_lines = lines[2:]
    
    if not dialogue_lines:
        return block 

    original_dialogue = "\n".join(dialogue_lines)
    translated_dialogue = translator.translate(original_dialogue)

    return header + '\n' + (translated_dialogue if translated_dialogue else "")

def process_srt_content(english_content):
    """‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ SRT ‡∂ú‡∑ú‡∂±‡∑î‡∑Ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä‡∑É‡∑ä ‡∑Ä‡∂Ω‡∂ß ‡∂ö‡∂©‡∑è, ‡∂ë‡∂ö‡∑í‡∂±‡∑ä ‡∂ë‡∂ö ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂∫‡∑í"""
    try:
        translator = GoogleTranslator(source='en', target='si')
        blocks = english_content.strip().split('\n\n')
        total_blocks = len(blocks)
        translated_blocks = []

        # Progress bar ‡∑É‡∑Ñ status text ‡∑É‡∂≥‡∑Ñ‡∑è placeholders ‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        progress_bar = st.progress(0)
        status_text = st.empty()

        for i, block in enumerate(blocks):
            translated_block = translate_srt_block(block, translator)
            translated_blocks.append(translated_block)
            
            # Progress bar ‡∂ë‡∂ö ‡∑É‡∑Ñ text ‡∂ë‡∂ö update ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            progress_percentage = int(((i + 1) / total_blocks) * 100)
            progress_bar.progress(progress_percentage)
            status_text.text(f"‡∂Ø‡∑ô‡∂∂‡∑É‡∑ä ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä {total_blocks}‡∂±‡∑ä {i + 1}‡∂ö‡∑ä ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì... ({progress_percentage}%)")
            time.sleep(0.01) # UI ‡∂ë‡∂ö update ‡∑Ä‡∑ô‡∂±‡∑ä‡∂± ‡∂¥‡∑ú‡∂©‡∑í ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑Ä‡∑è

        status_text.success("‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑í!")
        final_sinhala_srt = "\n\n".join(translated_blocks)
        return final_sinhala_srt

    except Exception as e:
        st.error(f"‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑í‡∑Ä‡∑í‡∂∫: {e}")
        return None

# --- Web App ‡∂ë‡∂ö‡∑ö ‡∂¥‡∑ô‡∂±‡∑î‡∂∏ ‡∑Ñ‡∂Ø‡∂± ‡∂≠‡∑ê‡∂± ---
st.set_page_config(page_title="‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∑É‡∂ö‡∑É‡∂±‡∂∫", page_icon="üìù")
st.title("üìù ‡∑É‡∂ª‡∂Ω ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∑É‡∂ö‡∑É‡∂±‡∂∫ v5.0 (Interactive)")
st.markdown("‡∂î‡∂∂‡∂ú‡∑ö ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∂ú‡∑ú‡∂±‡∑î‡∑Ä ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑ô‡∂±‡∑ä‡∂±. ‡∂ë‡∂∫ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä‡∂∏, ‡∂ö‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂ö‡∑ú‡∂ß‡∑É‡∂ö‡∑ä ‡∂∏‡∂ú‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ª, ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∂ß ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª ‡∂î‡∂∂‡∂ß ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑ô‡∂±‡∑î ‡∂á‡∂≠.")

st.subheader("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 1: ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í `.srt` ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö Upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±")
uploaded_file = st.file_uploader("‡∂î‡∂∂‡∂ú‡∑ö ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í .srt ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±", type=['srt'])

if uploaded_file is not None:
    st.success(f"'{uploaded_file.name}' ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂Ω‡∑ê‡∂∂‡∑î‡∂±‡∑í.")
    english_content = uploaded_file.getvalue().decode("utf-8")
    
    st.subheader("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 2: ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∂ª‡∂±‡∑ä‡∂±")
    
    if st.button("‚ú® ‡∂Ø‡∑ê‡∂±‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"):
        final_content = process_srt_content(english_content)
        
        if final_content:
            st.balloons() # ‡∑Ä‡∑ê‡∂©‡∑ö ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö ‡∑Ä‡∑î‡∂´‡∑è‡∂∏ ‡∂¥‡∑ú‡∂©‡∑í animation ‡∂ë‡∂ö‡∂ö‡∑ä
            st.subheader("‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂µ‡∂Ω‡∂∫: ‡∑É‡∂ö‡∑É‡∂± ‡∂Ω‡∂Ø ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö Download ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±")
            
            st.download_button(
               label="üì• ‡∑É‡∂ö‡∑É‡∂± ‡∂Ω‡∂Ø ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∂∏‡∑ô‡∂≠‡∂±‡∑í‡∂±‡∑ä ‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±",
               data=final_content.encode('utf-8'),
               file_name=f"fixed_sinhala_{uploaded_file.name}",
               mime="text/plain"
            )
