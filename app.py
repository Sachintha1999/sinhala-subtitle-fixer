# -*- coding: utf-8 -*-

import streamlit as st
from deep_translator import GoogleTranslator
import re

# --- ‡∂Ö‡∂¥‡∑ö ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ (Knowledge Base v0.1) ---
correction_rules = {
    # ‡∂∏‡∑ô‡∂≠‡∂±‡∂ß ‡∂Ö‡∂¥‡∑í ‡∑Ñ‡∑ú‡∂∫‡∑è‡∂ú‡∂±‡∑ä‡∂± ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∑Ä‡∂†‡∂± ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂∏‡∑î
    # ‡∂ã‡∂Ø‡∑è‡∑Ñ‡∂ª‡∂´‡∂∫‡∂ö‡∑ä: "‡∂ö‡∑ë‡∂Ω‡∑ä‡∂Ω‡∂ö‡∑ä": "‡∂Ω‡∑É‡∑ä‡∑É‡∂±‡∂∫‡∑í" 
}

def fix_sinhala_content(sinhala_content):
    """‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑Ö ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂ú‡∂≠‡∂∫ ‡∂Ö‡∂ª‡∂ú‡∑ô‡∂±, ‡∂Ö‡∂¥‡∑ö ‡∂ª‡∑ñ‡∂Ω‡∑ä‡∑É‡∑ä ‡∑Ä‡∂Ω‡∂ß ‡∂Ö‡∂±‡∑î‡∑Ä ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∂ª‡∂± function ‡∂ë‡∂ö."""
    # ‡∂Ø‡∑ê‡∂±‡∂ß ‡∂∏‡∑ô‡∂∏ function ‡∂ë‡∂ö ‡∂Ö‡∂¥‡∑í ‡∂¥‡∑è‡∑Ä‡∑í‡∂†‡∑ä‡∂†‡∑í ‡∂±‡∑ú‡∂ö‡∑Ö‡∂≠‡∑ä, ‡∂Ö‡∂±‡∑è‡∂ú‡∂≠‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂≠‡∂∂‡∑è‡∂ú‡∂±‡∑í‡∂∏‡∑î
    # ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂±‡∂∏‡∑ä, ‡∂¥‡∑Ñ‡∂≠ ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö:
    # for bad_phrase, good_phrase in correction_rules.items():
    #     sinhala_content = sinhala_content.replace(bad_phrase, good_phrase)
    return sinhala_content

def translate_srt_block(block, translator):
    """SRT ‡∂ë‡∂ö‡∂ö ‡∂≠‡∂±‡∑í ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä (‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∏, ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä, ‡∂Ø‡∑ô‡∂∂‡∑É) ‡∂Ö‡∂ª‡∂ú‡∑ô‡∂± ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂∫‡∑í"""
    if not block.strip():
        return ""
    
    lines = block.splitlines()
    
    # ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ë‡∂ö‡∂ö ‡∂Ö‡∑Ä‡∂∏ ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä 2‡∂ö‡∑ä (‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∏, ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä) ‡∂≠‡∑í‡∂∂‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í
    if len(lines) < 2:
        return block # ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ·É§·Éù·É†‡∂∏‡∑ê‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∂∏‡∑ä, ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂±‡∑ú‡∂ö‡∂ª ‡∂Ü‡∂¥‡∑É‡∑î ‡∂∫‡∑Ä‡∂∫‡∑í

    header = lines[0] + '\n' + lines[1]
    dialogue_lines = lines[2:]
    
    if not dialogue_lines:
        return block # ‡∂Ø‡∑ô‡∂∂‡∑É‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä, ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂±‡∑ú‡∂ö‡∂ª ‡∂Ü‡∂¥‡∑É‡∑î ‡∂∫‡∑Ä‡∂∫‡∑í

    original_dialogue = "\n".join(dialogue_lines)
    
    # ‡∂Ø‡∑ô‡∂∂‡∑É ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    translated_dialogue = translator.translate(original_dialogue)

    if not translated_dialogue:
        translated_dialogue = "" # ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∑Ñ‡∑í‡∑É‡∑ä ‡∑Ä‡∑î‡∑Ä‡∑Ñ‡∑ú‡∂≠‡∑ä

    return header + '\n' + translated_dialogue

def process_srt_content(english_content):
    """‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ SRT ‡∂ú‡∑ú‡∂±‡∑î‡∑Ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä‡∑É‡∑ä ‡∑Ä‡∂Ω‡∂ß ‡∂ö‡∂©‡∑è, ‡∂ë‡∂ö‡∑í‡∂±‡∑ä ‡∂ë‡∂ö ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂∫‡∑í"""
    try:
        translator = GoogleTranslator(source='en', target='si')
        
        # SRT ‡∂ú‡∑ú‡∂±‡∑î‡∑Ä ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä‡∑É‡∑ä ‡∑Ä‡∂Ω‡∂ß ‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (‡∂ë‡∂ö ‡∂Ø‡∑ô‡∂∂‡∑É‡∂ö‡∂ß ‡∂ë‡∂ö ‡∂∂‡∑ä‡∂Ω‡∑ú‡∂ö‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä)
        blocks = english_content.strip().split('\n\n')
        
        translated_blocks = [translate_srt_block(block, translator) for block in blocks]
        
        # ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω SRT ‡∂ú‡∑ú‡∂±‡∑î‡∑Ä ‡∑É‡∂ö‡∑É‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        final_sinhala_srt = "\n\n".join(translated_blocks)

        # ‡∂Ö‡∂¥‡∑ö ‡∑É‡∑í‡∑É‡∑ä‡∂ß‡∂∏‡∑ä ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (‡∂Ö‡∂±‡∑è‡∂ú‡∂≠‡∂∫‡∑ö‡∂Ø‡∑ì ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂±‡∂∏‡∑ä)
        # final_sinhala_srt = fix_sinhala_content(final_sinhala_srt)

        return final_sinhala_srt

    except Exception as e:
        st.error(f"‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑í‡∑Ä‡∑í‡∂∫: {e}")
        return None

# --- Web App ‡∂ë‡∂ö‡∑ö ‡∂¥‡∑ô‡∂±‡∑î‡∂∏ ‡∑Ñ‡∂Ø‡∂± ‡∂≠‡∑ê‡∂± ---
st.set_page_config(page_title="‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∑É‡∂ö‡∑É‡∂±‡∂∫", page_icon="üìù")
st.title("üìù ‡∑É‡∂ª‡∂Ω ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∑É‡∂ö‡∑É‡∂±‡∂∫ v4.0 (‡∑É‡∑ä‡∂Æ‡∑è‡∑Ä‡∂ª)")
st.markdown("‡∂î‡∂∂‡∂ú‡∑ö ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í ‡∂ú‡∑ú‡∂±‡∑î‡∑Ä ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑ô‡∂±‡∑ä‡∂±. ‡∂ë‡∂∫ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä‡∂∏, ‡∂ö‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂ö‡∑ú‡∂ß‡∑É‡∂ö‡∑ä ‡∂∏‡∂ú‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ª, ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∂ß ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª ‡∂î‡∂∂‡∂ß ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑ô‡∂±‡∑î ‡∂á‡∂≠.")

st.subheader("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 1: ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í `.srt` ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö Upload ‡∂ö‡∂ª‡∂±‡∑ä‡∂±")
uploaded_file = st.file_uploader("‡∂î‡∂∂‡∂ú‡∑ö ‡∂â‡∂Ç‡∂ú‡∑ä‚Äç‡∂ª‡∑ì‡∑É‡∑í .srt ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±", type=['srt'])

if uploaded_file is not None:
    st.success(f"'{uploaded_file.name}' ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂Ω‡∑ê‡∂∂‡∑î‡∂±‡∑í.")
    english_content = uploaded_file.getvalue().decode("utf-8")
    
    st.subheader("‡∂¥‡∑í‡∂∫‡∑Ä‡∂ª 2: ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∂ª‡∂±‡∑ä‡∂±")
    
    if st.button("‚ú® ‡∂Ø‡∑ê‡∂±‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"):
        with st.spinner("‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í‡∂∫ ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´‡∂∫ ‡∂ö‡∂ª, ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∂ª‡∑í‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ª‡∑ê‡∂≥‡∑ì ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±..."):
            final_content = process_srt_content(english_content)
        
        if final_content:
            st.success("‡∂±‡∑í‡∂∫‡∂∏‡∂∫‡∑í! ‡∂î‡∂∂‡∂ú‡∑ö ‡∂ã‡∂¥‡∑É‡∑í‡∂ª‡∑ê‡∑É‡∑í‡∂∫ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂∫‡∑ô‡∂±‡∑ä‡∂∏ ‡∑É‡∂ö‡∑É‡∑è ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä.")
            st.subheader("‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂µ‡∂Ω‡∂∫: ‡∑É‡∂ö‡∑É‡∂± ‡∂Ω‡∂Ø ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö Download ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±")
            
            st.download_button(
               label="üì• ‡∑É‡∂ö‡∑É‡∂± ‡∂Ω‡∂Ø ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∑Ü‡∂∫‡∑í‡∂Ω‡∑ä ‡∂ë‡∂ö ‡∂∏‡∑ô‡∂≠‡∂±‡∑í‡∂±‡∑ä ‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±",
               data=final_content.encode('utf-8'),
               file_name=f"fixed_sinhala_{uploaded_file.name}",
               mime="text/plain"
            )
